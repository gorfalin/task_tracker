import sys
import json
from PyQt5.QtWidgets import QApplication, QMainWindow, QWidget, QVBoxLayout, QPushButton, QLineEdit, QLabel
from PyQt5.QtCore import Qt, QDate

class DataApp(QMainWindow):
    FILE_NAME = "habits.json"

    def __init__(self):
        super().__init__()
        self.setWindowTitle("Работа с данными")
        self.setGeometry(100, 100, 400, 300)

        # Загрузка данных
        self.habits = self.load_from_file()

        # Основные виджеты
        self.input = QLineEdit("", self)
        self.label = QLabel("Сохранённые привычки:", self)
        self.list_label = QLabel()
        self.add_button = QPushButton("Добавить", self)
        self.save_button = QPushButton("Сохранить", self)

        # Макет
        layout = QVBoxLayout()
        layout.addWidget(self.input)
        layout.addWidget(self.add_button)
        layout.addWidget(self.label)
        layout.addWidget(self.list_label)
        layout.addWidget(self.save_button)

        container = QWidget()
        container.setLayout(layout)
        self.setCentralWidget(container)

        # События
        self.add_button.clicked.connect(self.add_habit)
        self.save_button.clicked.connect(self.save_to_file)

        self.update_list_display()

    def add_habit(self):
        name = self.input.text().strip()
        if name and name != "Введите привычку":
            key = f"{QDate.currentDate().year()}-{QDate.currentDate().month()}"
            if key not in self.habits:
                self.habits[key] = []
            self.habits[key].append({"name": name})
            self.input.clear()
            self.update_list_display()

    def update_list_display(self):
        key = f"{QDate.currentDate().year()}-{QDate.currentDate().month()}"
        habits = self.habits.get(key, [])
        text = "\n".join([h["name"] for h in habits])
        self.list_label.setText(text if text else "Нет добавленных привычек")

    def save_to_file(self):
        with open(self.FILE_NAME, "w", encoding="utf-8") as f:
            json.dump(self.habits, f, ensure_ascii=False, indent=4)
        self.statusBar().showMessage("Данные сохранены в файл")

    def load_from_file(self):
        try:
            with open(self.FILE_NAME, "r", encoding="utf-8") as f:
                return json.load(f)
        except (FileNotFoundError, json.JSONDecodeError):
            return {}


if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = DataApp()
    window.show()
    sys.exit(app.exec_())
